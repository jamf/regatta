apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ template "meta.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ template "meta.name" . }}
    chart: {{ template "meta.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    team: {{ .Values.team }}
    version: {{ .Values.image.tag | quote }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: {{ template "meta.name" . }}
      release: {{ .Release.Name }}
  serviceName: {{ template "meta.name" . }}
  template:
    metadata:
      labels:
        app: {{ template "meta.name" . }}
        release: {{ .Release.Name }}
        version: {{ .Values.image.tag | quote }}
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: {{ .Values.safeToEvict | quote }}
    spec:
      serviceAccountName: {{ template "meta.name" . }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      containers:
      - name: {{ template "meta.name" . }}
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.imagePullPolicy }}
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command:
        - "bash"
        - "-c"
        - >-
          NODE_ID=$(expr $(echo "${POD_NAME: -1}") + 1) &&
          regatta \
            --api.address=0.0.0.0:{{ .Values.internalPort }} \
            --experimental.tables-api-address=0.0.0.0:{{ .Values.internalPortTables }} \
            --experimental.tables-consume-kafka={{ .Values.experimental.tablesConsumeKafka }} \
            --experimental.tables-names={{ .Values.experimental.tablesNames }}
            --api.cert-filename=/cert/tls.crt \
            --api.key-filename=/cert/tls.key \
            --rest.address=0.0.0.0:{{ .Values.metricsPort }} \
            --raft.address=$(POD_NAME).{{ template "meta.name" . }}.{{ .Release.Namespace }}.svc.cluster.local:5012 \
            --raft.listen-address=0.0.0.0:5012 \
            --raft.node-id=${NODE_ID} \
            --raft.node-host-dir=/data/raft \
            --raft.initial-members={{ .Values.raft.initialMembers }} \
            --raft.state-machine-dir=/data/state-machine \
            --raft.rtt={{ .Values.raft.rtt }} \
          {{- if .Values.reflectionAPI.enabled }}
            --api.reflection-api \
          {{- end }}
          {{- if .Values.kafka.enabled }}
            --kafka.brokers={{ .Values.kafka.brokers }} \
            --kafka.check-topics={{ .Values.kafka.checkTopics }} \
            --kafka.timeout={{ .Values.kafka.dialerTimeout }} \
            --kafka.group-id={{ .Values.kafka.groupID }} \
            --kafka.topics={{ .Values.kafka.topics }} \
            --kafka.tls={{ .Values.kafka.tls }} \
            --kafka.server-cert-filename=/kafka-cert/ca.crt \
            --kafka.client-cert-filename=/kafka-cert/tls.crt \
            --kafka.client-key-filename=/kafka-cert/tls.key
          {{- end }}
        ports:
        - name: https
          containerPort: {{ .Values.internalPort }}
        - name: https-tables
          containerPort: {{ .Values.internalPortTables }}
        - name: http-metrics
          containerPort: {{ .Values.metricsPort }}
        resources: {{- toYaml .Values.resources | nindent 10 }}
        readinessProbe:
          httpGet:
            path: /healthz
            port: {{ .Values.metricsPort }}
          initialDelaySeconds: 90
          periodSeconds: 60
        volumeMounts:
        - mountPath: /cert
          name: cert
        {{- if ne .Values.kafka.serverCert ""}}
        - mountPath: /kafka-cert
          name: kafka-cert
        {{- end }}
        - mountPath: /data
          name: data
      volumes:
      - name: cert
        secret:
          defaultMode: 420
          secretName: {{ template "meta.name" . }}-cert
      {{- if ne .Values.kafka.serverCert ""}}
      - name: kafka-cert
        secret:
          defaultMode: 420
          secretName: {{ template "meta.name" . }}-kafka-cert
      {{- end }}
      {{- if .Values.tolerations }}
      tolerations: {{- toYaml .Values.tolerations | nindent 6 }}
      {{- end }}
      {{- if .Values.nodeSelector }}
      nodeSelector: {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- end }}
      {{ if .Values.affinity }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: {{ .Values.affinity.podAntiAffinity.topologyKey }}
            labelSelector:
              matchLabels:
                app: {{ template "meta.name" . }}
                release: {{ .Release.Name }}
      {{- end }}
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data
    spec:
    {{ .Values.persistence.storage | toYaml | nindent 6 }}
